import{H3Event as v,getResponseHeaders as U,getRequestWebStream as z,getRequestURL as Q,eventHandler as V}from"h3";import{getContext as J}from"unctx";import{AsyncLocalStorage as Z}from"node:async_hooks";import{isPlainArray as G,isPlainObject as P,defer as X,useRouter as _,pick as K,ScriptOnce as w,createControlledPromise as Y,TSR_DEFERRED_PROMISE as C,RouterProvider as ee,createMemoryHistory as te,useRouterState as S,createRootRoute as re,Outlet as ne,ScrollRestoration as oe,createFileRoute as I,lazyRouteComponent as q,createRouter as se}from"@tanstack/react-router";import{jsxs as h,Fragment as f,jsx as c}from"react/jsx-runtime";import*as y from"react";import{createElement as A}from"react";import g from"jsesc";import ae from"tiny-invariant";import{Transform as ie,PassThrough as ce}from"node:stream";import{isbot as M}from"isbot";import R from"react-dom/server";import{Context as L}from"@tanstack/react-cross-context";function ue(e,r,t){if(!t.router.isServer)return r;t.match.extracted=t.match.extracted||[];const n=t.match.extracted;return T(r,(o,a)=>{const i=o instanceof ReadableStream?"stream":o instanceof Promise?"promise":void 0;if(i==="stream"){const[u,l]=o.tee(),d={dataType:e,type:i,path:a,id:n.length,matchIndex:t.match.index,streamState:pe({stream:l})};return n.push(d),u}else if(i==="promise"){X(o);const u={dataType:e,type:i,path:a,id:n.length,matchIndex:t.match.index,promiseState:o};n.push(u)}return o})}function le(e){const r=_(),t=r.state.matches[e.matchIndex];if(!r.isServer)return null;const n=t.extracted,[s,o]=["__beforeLoadContext","loaderData"].map(a=>n?n.reduce((i,u)=>u.dataType!==a?b(i,["temp",...u.path],void 0):i,{temp:t[a]}).temp:t[a]);if(s!==void 0||o!==void 0||n?.length){const a=`__TSR__.initMatch(${g({index:e.matchIndex,__beforeLoadContext:r.options.transformer.stringify(s),loaderData:r.options.transformer.stringify(o),extracted:n?Object.fromEntries(n.map(i=>[i.id,K(i,["type","path"])])):{}},{isScriptContext:!0,wrap:!0,json:!0})})`;return h(f,{children:[c(w,{children:a}),n?n.map(i=>i.type==="stream"?c(fe,{entry:i},i.id):c(de,{entry:i},i.id)):null]})}return null}function T(e,r,t=[]){if(G(e))return e.map((s,o)=>T(s,r,[...t,`${o}`]));if(P(e)){const s={};for(const o in e)s[o]=T(e[o],r,[...t,o]);return s}const n=r(e,t);return n!==e?n:e}function de({entry:e}){return c("div",{className:"tsr-once",children:c(y.Suspense,{fallback:null,children:c(me,{entry:e})})})}function me({entry:e}){const r=_();if(e.promiseState[C].status==="pending")throw e.promiseState;const t=`__TSR__.resolvePromise(${g({...e,value:e.promiseState[C]},{isScriptContext:!0,wrap:!0,json:!0})})`;return r.injectScript(t),c(f,{})}function fe({entry:e}){ae(e.streamState,"StreamState should be defined");const r=_();return c(D,{streamState:e.streamState,children:t=>{const n=t?`__TSR__.matches[${e.matchIndex}].extracted[${e.id}].value.controller.enqueue(new TextEncoder().encode(${g(t.toString(),{isScriptContext:!0,wrap:!0,json:!0})}))`:`__TSR__.matches[${e.matchIndex}].extracted[${e.id}].value.controller.close()`;return r.injectScript(n),c(f,{})}})}function pe({stream:e}){const r={promises:[]},t=e.getReader(),n=s=>(r.promises[s]=Y(),t.read().then(({done:o,value:a})=>{if(o){r.promises[s].resolve(null),t.releaseLock();return}return r.promises[s].resolve(a),n(s+1)}));return n(0).catch(s=>{console.error("stream read error",s)}),r}function D({streamState:e,children:r,__index:t=0}){const n=e.promises[t];if(!n)return null;if(n.status==="pending")throw n;const s=n.value;return h(f,{children:[r(s),c("div",{className:"tsr-once",children:c(y.Suspense,{fallback:null,children:c(D,{streamState:e,__index:t+1,children:r})})})]})}function b(e,r,t){if(r.length===0)return t;const[n,...s]=r;return Array.isArray(e)?e.map((o,a)=>a===Number(n)?b(o,s,t):o):P(e)?{...e,[n]:b(e[n],s,t)}:e}function k(e){e.router.AfterEachMatch=le,e.router.serializer=n=>g(n,{isScriptContext:!0,wrap:!0,json:!0});const r=L.get("TanStackRouterHydrationContext",{}),t=y.useMemo(()=>{var n,s;return{router:e.router.dehydrate(),payload:(s=(n=e.router.options).dehydrate)==null?void 0:s.call(n)}},[e.router]);return c(r.Provider,{value:t,children:c(ee,{router:e.router})})}function he(e){let r;const t=W(e),n={duplex:"half",method:e.method,headers:e.headers};return e.node.req.body instanceof ArrayBuffer?new Request(t,{...n,body:e.node.req.body}):new Request(t,{...n,get body(){return r||(r=Re(e),r)}})}function _e(e){return e.web??={request:he(e),url:W(e)},e.web.request}function Se(){return ve()}const B=Symbol("$HTTPEvent");function ye(e){return typeof e=="object"&&(e instanceof v||e?.[B]instanceof v||e?.__is_event__===!0)}function E(e){return function(...r){let t=r[0];if(ye(t))r[0]=t instanceof v||t.__is_event__?t:t[B];else{if(!globalThis.app.config.server.experimental?.asyncContext)throw new Error("AsyncLocalStorage was not enabled. Use the `server.experimental.asyncContext: true` option in your app configuration to enable it. Or, pass the instance of HTTPEvent that you have as the first argument to the function.");if(t=Se(),!t)throw new Error("No HTTPEvent found in AsyncLocalStorage. Make sure you are using the function within the server runtime.");r.unshift(t)}return e(...r)}}const W=E(Q),ge=E(U),Re=E(z);function xe(){return J("nitro-app",{asyncContext:!!globalThis.app.config.server.experimental?.asyncContext,AsyncLocalStorage:Z})}function ve(){return xe().use().event}function we(e){return e instanceof Headers?new Headers(e):Array.isArray(e)?new Headers(e):typeof e=="object"?new Headers(e):new Headers}function $(...e){return e.reduce((r,t)=>{const n=we(t);for(const[s,o]of n.entries())r.set(s,o);return r},new Headers)}function Te({createRouter:e,getRouterManifest:r}){return t=>V(async n=>{const s=_e(n),o=new URL(s.url),a=o.href.replace(o.origin,""),i=te({initialEntries:[a]}),u=e();u.serializeLoaderData=ue,r&&(u.manifest=r()),u.update({history:i}),await u.load();const l=be({event:n,router:u});return await t({request:s,router:u,responseHeaders:l})})}function be(e){e.event.__tsrHeadersSent=!0;let r=$(ge(e.event),{"Content-Type":"text/html; charset=UTF-8"},...e.router.state.matches.map(n=>n.headers));const{redirect:t}=e.router.state;return t&&(r=$(r,t.headers,{Location:t.href})),r}function Ee(e){const r=O(()=>e.injectedHtml.map(t=>t()).join(""));return new ie({transform(t,n,s){r.transform(t,this.push.bind(this)).then(()=>s()).catch(o=>s(o))},flush(t){r.flush(this.push.bind(this)).then(()=>t()).catch(n=>t(n))}})}function He(e){const r=O(()=>e.injectedHtml.map(n=>n()).join("")),t=new TextEncoder;return new TransformStream({transform(n,s){return r.transform(n,o=>(s.enqueue(t.encode(o)),!0))},flush(n){return r.flush(s=>(n.enqueue(s),!0))}})}const Ce=/(<body)/,Me=/(<\/body>)/,ke=/(<\/html>)/,$e=/(<\/[a-zA-Z][\w:.-]*?>)/g,Pe=new TextDecoder;function O(e){let r=!1,t="",n="";return{async transform(s,o){const a=t+Pe.decode(s),i=a.match(Ce),u=a.match(Me),l=a.match(ke);try{if(i&&(r=!0),!r){o(a),t="";return}const d=e();if(u&&l&&u.index<l.index){const m=u.index+u[0].length,p=l.index+l[0].length,x=a.slice(0,m)+d+a.slice(m,p)+a.slice(p);o(x),t=""}else{let m,p=0;for(;(m=$e.exec(a))!==null;)p=m.index+m[0].length;if(p>0){const x=a.slice(0,p)+d+n;o(x),t=a.slice(p)}else t=a,n+=d}}catch(d){throw console.error("Error transforming HTML:",d),d}},async flush(s){t&&s(t)}}}const Ie=async({request:e,router:r,responseHeaders:t})=>{if(typeof R.renderToReadableStream=="function"){const n=await R.renderToReadableStream(c(k,{router:r}),{signal:e.signal});M(e.headers.get("User-Agent"))&&await n.allReady;const o=[He(r)].reduce((a,i)=>a.pipeThrough(i),n);return new Response(o,{status:r.state.statusCode,headers:t})}if(typeof R.renderToPipeableStream=="function"){const n=new ce;try{const a=R.renderToPipeableStream(c(k,{router:r}),{...M(e.headers.get("User-Agent"))?{onAllReady(){a.pipe(n)}}:{onShellReady(){a.pipe(n)}},onError:(i,u)=>{console.log("Error in renderToPipeableStream:",i,u)}})}catch(a){console.log("Error in renderToPipeableStream:",a)}const o=[Ee(r)].reduce((a,i)=>a.pipe(i),n);return new Response(o,{status:r.state.statusCode,headers:t})}throw new Error("No renderToReadableStream or renderToPipeableStream found in react-dom/server. Ensure you are using a version of react-dom that supports streaming.")},qe=()=>({routes:{__root__:{filePath:"__root.tsx",children:["/","/view/$token"],preloads:["/_build/assets/client-Dm27tvEQ.js","/_build/assets/client-BXl7ZxVm.js"]},"/":{filePath:"index.tsx"},"/view/$token":{filePath:"view/$token.tsx"}}});function Ae(e){return globalThis.MANIFEST[e]}function Le(){const e=qe(),r=e.routes.__root__=e.routes.__root__||{};r.assets=r.assets||[];const t=Ae("client");return r.assets.push({tag:"script",attrs:{src:t.inputs[t.handler]?.output.path,type:"module",async:!0,suppressHydrationWarning:!0}}),e}function De(){const e=Le();return{...e,routes:Object.fromEntries(Object.entries(e.routes).map(([r,t])=>{const{preloads:n,assets:s}=t;return[r,{preloads:n,assets:s}]}))}}function j({tag:e,attrs:r,children:t}){switch(e){case"title":return c("title",{...r,suppressHydrationWarning:!0,children:t});case"meta":return c("meta",{...r,suppressHydrationWarning:!0});case"link":return c("link",{...r,suppressHydrationWarning:!0});case"style":return c("style",{...r,dangerouslySetInnerHTML:{__html:t}});case"script":return r&&r.src?c("script",{...r,suppressHydrationWarning:!0}):typeof t=="string"?c("script",{...r,dangerouslySetInnerHTML:{__html:t},suppressHydrationWarning:!0}):null;default:return null}}const Be=()=>{const e=_(),r=S({select:o=>o.matches.map(a=>a.meta).filter(Boolean)}),t=y.useMemo(()=>{const o=[],a={};let i;return[...r].reverse().forEach(u=>{[...u].reverse().forEach(l=>{if(l)if(l.title)i||(i={tag:"title",children:l.title});else{const d=l.name??l.property;if(d){if(a[d])return;a[d]=!0}o.push({tag:"meta",attrs:{...l}})}})}),i&&o.push(i),o.reverse(),o},[r]),n=S({select:o=>o.matches.map(a=>a.links).filter(Boolean).flat(1).map(a=>({tag:"link",attrs:{...a}})),structuralSharing:!0}),s=S({select:o=>{const a=[];return o.matches.map(i=>e.looseRoutesById[i.routeId]).forEach(i=>{var u,l,d;return(d=(l=(u=e.manifest)==null?void 0:u.routes[i.id])==null?void 0:l.preloads)==null?void 0:d.filter(Boolean).forEach(m=>{a.push({tag:"link",attrs:{rel:"modulepreload",href:m}})})}),a},structuralSharing:!0});return je([...t,...s,...n],o=>JSON.stringify(o))},We=()=>{const e=_(),r=Be(),t=y.useContext(L.get("TanStackRouterHydrationContext",{}));return h(f,{children:[r.map((n,s)=>A(j,{...n,key:`tsr-meta-${JSON.stringify(n)}`})),h(f,{children:[c(w,{log:!1,children:'__TSR__={matches:[],streamedValues:{},queue:[],runQueue:()=>{let e=!1;__TSR__.queue=__TSR__.queue.filter((_=>!_()||(e=!0,!1))),e&&__TSR__.runQueue()},initMatch:e=>{__TSR__.queue.push((()=>(__TSR__.matches[e.index]||(__TSR__.matches[e.index]=e,Object.entries(e.extracted).forEach((([e,_])=>{if("stream"===_.type){let e;_.value=new ReadableStream({start(_){e=_}}),_.value.controller=e}else if("promise"===_.type){let e,t;_.value=new Promise(((_,u)=>{e=_,t=u})),_.resolve=e,_.reject=t}}))),!0))),__TSR__.runQueue()},resolvePromise:e=>{__TSR__.queue.push((()=>{const _=__TSR__.matches[e.matchIndex];if(_){const t=_.extracted[e.id];if(t)return t.resolve(e.value.data),!0}return!1})),__TSR__.runQueue()},cleanScripts:()=>{document.querySelectorAll(".tsr-once").forEach((e=>{e.remove()}))}};'}),c(w,{children:`__TSR__.dehydrated = ${g(e.options.transformer.stringify(t),{isScriptContext:!0,wrap:!0,json:!0})}`})]})]})},Oe=()=>c(f,{children:We()});function je(e,r){const t=new Set;return e.filter(n=>{const s=r(n);return t.has(s)?!1:(t.add(s),!0)})}const Fe=()=>{const e=_(),r=S({select:s=>{const o=[];return s.matches.map(a=>e.looseRoutesById[a.routeId]).forEach(a=>{var i,u,l;return(l=(u=(i=e.manifest)==null?void 0:i.routes[a.id])==null?void 0:u.assets)==null?void 0:l.filter(d=>d.tag==="script").forEach(d=>{o.push({tag:"script",attrs:d.attrs,children:d.children})})}),o},structuralSharing:!0}),{scripts:t}=S({select:s=>({scripts:s.matches.map(o=>o.scripts).flat(1).filter(Boolean).map(({children:o,...a})=>({tag:"script",attrs:{...a,suppressHydrationWarning:!0},children:o}))})}),n=[...t,...r];return c(f,{children:n.map((s,o)=>A(j,{...s,key:`tsr-scripts-${s.tag}-${o}`}))})},H=re({head:()=>({meta:[{charSet:"utf-8"},{name:"viewport",content:"width=device-width, initial-scale=1"},{title:"Little Journey - View Memories"}],links:[{rel:"icon",href:"/favicon.ico"}]}),component:Ne});function Ne(){return c(Ue,{children:c(ne,{})})}function Ue({children:e}){return h("html",{lang:"en",children:[c("head",{children:c(Oe,{})}),h("body",{children:[e,c(oe,{}),c(Fe,{})]})]})}const ze=()=>import("./index-CQjyKwuU.js"),F=I("/")({component:q(ze,"component",()=>F.ssr)}),Qe=()=>import("./_token-D40ldlJf.js"),N=I("/view/$token")({component:q(Qe,"component",()=>N.ssr)}),Ve=F.update({id:"/",path:"/",getParentRoute:()=>H}),Je=N.update({id:"/view/$token",path:"/view/$token",getParentRoute:()=>H}),Ze={IndexRoute:Ve,ViewTokenRoute:Je},Ge=H._addFileChildren(Ze)._addFileTypes();function Xe(){return se({routeTree:Ge,scrollRestoration:!0})}const lt=Te({createRouter:Xe,getRouterManifest:De})(Ie);export{N as R,lt as h};
